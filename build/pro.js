(()=>{"use strict";const e=e=>"boolean"==typeof e?e:"string"==typeof e?"1"===e||"true"===e.toLowerCase():"number"==typeof e?1===e:!!e,t=e=>{if(!e?.bodyAttributes)return;const t=document.body;t&&Object.entries({themeMode:"theme",buttonSize:"button-size",buttonPosition:"position",borderRadius:"border-radius",shadowStyle:"shadow"}).forEach(([i,n])=>{const a=e.bodyAttributes[i],s=`data-chatkit-${n}`;null!=a&&""!==a?t.setAttribute(s,String(a)):t.removeAttribute(s)})},i=e=>{const t=document.createElement("div");t.style.cssText='position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; background: #f8d7da; color: #721c24; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 9999; max-width: 300px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;',t.setAttribute("role","alert"),t.innerHTML=`<p style="margin: 0; font-size: 14px;">${e}</p>`,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&(t.style.opacity="0",t.style.transition="opacity 0.3s ease",setTimeout(()=>t.remove(),300))},5e3)},n=(e={})=>e?.features?.mode?"pro"===e.features.mode:"boolean"!=typeof e.isPro||e.isPro;class a{constructor(e){this.config=e||{}}resolveFlag(e){return this.config?.features&&Object.prototype.hasOwnProperty.call(this.config.features,e)?!1!==this.config.features[e]:n(this.config)}isQuickPromptEnabled(){return this.resolveFlag("quickPrompts")}isAdvancedOptionsEnabled(){return this.resolveFlag("advancedOptions")}isChannelPickerEnabled(){return this.resolveFlag("channelPicker")}}class s{constructor(e,{showError:t,flags:i}){this.config=e||{},this.flags=i,this.showError=t,this.picker=document.getElementById("chatkitChannelPicker"),this.emailPanel=document.getElementById("chatkitEmailPanel"),this.emailForm=document.getElementById("chatkitEmailForm"),this.backButtons=Array.from(document.querySelectorAll(".chatkit-back-button")),this.onChannelSelected=null,this.onEmailSent=null}isEnabled(){return this.flags.isChannelPickerEnabled()&&this.picker&&this.emailPanel}getContainers(){return[this.picker,this.emailPanel].filter(Boolean)}hideAll(){this.picker&&(this.picker.hidden=!0,this.picker.style.display="none"),this.emailPanel&&(this.emailPanel.hidden=!0,this.emailPanel.style.display="none")}showPicker(){this.isEnabled()&&(this.emailPanel&&(this.emailPanel.hidden=!0,this.emailPanel.style.display="none"),this.picker.hidden=!1,this.picker.style.display="flex")}focusPicker(){if(!this.isEnabled())return;const e=this.picker.querySelector(".chatkit-channel-card");e?.focus()}showEmail(){this.isEnabled()&&(this.picker&&(this.picker.hidden=!0,this.picker.style.display="none"),this.emailPanel&&(this.emailPanel.hidden=!1,this.emailPanel.style.display="block",setTimeout(()=>{const e=this.emailPanel.querySelector('input[name="email"]');e?.focus()},120)))}handleEmailSubmit(e){e.preventDefault();const t=(this.emailPanel?.dataset?.contactEmail||"").trim();if(!t)return void this.showError?.("Email destination not configured. Please contact the site administrator.");const i=this.emailForm?.querySelector('input[name="email"]'),n=this.emailForm?.querySelector('textarea[name="message"]'),a=i?i.value.trim():"",s=n?n.value.trim():"",o=encodeURIComponent(`Website enquiry from ${a||"visitor"}`),r=[];a&&(r.push(`From: ${a}`),r.push("")),s&&r.push(s);const l=encodeURIComponent(r.join("\n"));window.location.href=`mailto:${t}?subject=${o}&body=${l}`,this.onEmailSent?.()}attachChannelHandlers(){this.picker&&this.picker.querySelectorAll("[data-channel]").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-channel");this.onChannelSelected?.(t)})})}attachBackHandlers(){this.backButtons.forEach(e=>{e.addEventListener("click",()=>{this.showPicker(),this.focusPicker()})})}init({onChannelSelected:e,onEmailSent:t}){this.isEnabled()&&(this.onChannelSelected=e,this.onEmailSent=t,this.attachChannelHandlers(),this.attachBackHandlers(),this.emailForm&&this.emailForm.addEventListener("submit",e=>this.handleEmailSubmit(e)))}}class o{constructor({button:e,chatkitElement:t,channelPicker:i,accentColor:n,originalLabel:a,closeLabel:s,flags:o}){this.button=e,this.chatkitElement=t,this.channelPicker=i&&i.isEnabled()?i:null,this.accentColor=n||"#FF4500",this.originalLabel=a||"Toggle chat window",this.closeLabel=s||this.originalLabel,this.nudgeManager=null,this.isOpen=!1,this.flags=o,this.containers=[this.chatkitElement]}setNudgeManager(e){this.nudgeManager=e}init({onOpenFallbackChat:e}={}){return!(!this.button||!this.chatkitElement||(this.flags.isChannelPickerEnabled()&&this.channelPicker&&(this.channelPicker.init({onChannelSelected:t=>this.handleChannelSelection(t,e),onEmailSent:()=>this.close()}),this.containers.push(...this.channelPicker.getContainers())),this.button.addEventListener("click",()=>{this.isOpen?this.close():this.open()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen&&this.close()}),document.addEventListener("click",e=>{this.isOpen&&(this.containers.some(t=>t&&t.contains(e.target))||this.button.contains(e.target)||this.close())}),0))}handleChannelSelection(e,t){"email"!==e?"chat"!==e?"function"==typeof t&&t():this.showChat():this.channelPicker?.showEmail()}scheduleInitialNudge(){this.nudgeManager?.scheduleInitial?.()}open(e){this.isOpen||(this.isOpen=!0,this.button.classList.add("chatkit-open"),this.button.style.backgroundColor=this.accentColor,this.button.setAttribute("aria-expanded","true"),this.button.setAttribute("aria-label",this.closeLabel),!this.flags.isChannelPickerEnabled()||!this.channelPicker||"picker"!==e&&e?this.flags.isChannelPickerEnabled()&&this.channelPicker&&"email"===e?this.channelPicker.showEmail():this.showChat():(this.channelPicker.showPicker(),this.channelPicker.focusPicker()),this.nudgeManager?.cancel?.(),this.nudgeManager?.hide?.(),window.innerWidth<=768&&(document.body.style.overflow="hidden"))}showChat(){this.channelPicker?.hideAll(),this.chatkitElement.hidden=!1,this.chatkitElement.style.display="block",this.chatkitElement.setAttribute("aria-modal","true"),setTimeout(()=>this.chatkitElement.focus(),140)}close(){this.isOpen&&(this.isOpen=!1,this.button.classList.remove("chatkit-open"),this.button.style.backgroundColor=this.accentColor,this.button.setAttribute("aria-expanded","false"),this.button.setAttribute("aria-label",this.originalLabel),this.channelPicker?.hideAll(),this.chatkitElement.hidden=!0,this.chatkitElement.style.display="none",this.chatkitElement.setAttribute("aria-modal","false"),document.body.style.overflow="",this.nudgeManager?.scheduleRepeat?.())}}const r=window.chatkitConfig||{};r.isPro=n(r);const l=new a(r),c=new class{constructor(e,t=new a(e)){this.config=e||{},this.flags=t}isEnabled(){return this.flags.isQuickPromptEnabled()}extractPrompt(e,t,i){var n,a,s,o;const r=null!==(n=this.config[e])&&void 0!==n?n:this.config[this.toSnakeCase(e)],l=null!==(a=this.config[t])&&void 0!==a?a:this.config[this.toSnakeCase(t)],c=null!==(s=null!==(o=this.config[i])&&void 0!==o?o:this.config[this.toSnakeCase(i)])&&void 0!==s?s:"circle-question";return r&&l?{icon:c,label:r,prompt:l}:null}toSnakeCase(e){return e.replace(/([a-z0-9])([A-Z])/g,"$1_$2").replace(/([A-Za-z])([0-9]+)/g,"$1_$2").toLowerCase()}getPrompts(){if(!this.isEnabled())return[];const e=this.config.prompts,t=[];if(Array.isArray(e)&&e.length>0)e.forEach(e=>{e&&e.label&&e.text&&t.push({icon:e.icon||"circle-question",label:e.label,prompt:e.text})});else for(let e=1;e<=5;e+=1){const i=this.extractPrompt(`defaultPrompt${e}`,`defaultPrompt${e}Text`,`defaultPrompt${e}Icon`);i&&t.push(i)}return t.length||t.push({icon:"circle-question",label:"How can I assist you?",prompt:"Hi! How can I assist you today?"}),t}}(r,l),h=new class{constructor(e,t=new a(e)){this.config=e||{},this.flags=t}enhancementsEnabled(){return this.flags.isAdvancedOptionsEnabled()}applyAttachments(t){const i=e(this.config.enableAttachments);if(t.composer=t.composer||{},t.composer.attachments=t.composer.attachments||{},t.composer.attachments.enabled=i,!i)return;const n=parseInt(this.config.attachmentMaxSize||20,10),a=parseInt(this.config.attachmentMaxCount||3,10);t.composer.attachments=Object.assign(t.composer.attachments,{maxSize:1024*n*1024,maxCount:a,accept:{"application/pdf":[".pdf"],"image/*":[".png",".jpg",".jpeg",".gif",".webp"],"text/plain":[".txt"]}})}applyInitialThread(e){const t=this.config.initialThreadId||this.config.initial_thread_id;t&&""!==t.trim()&&(e.initialThread=t)}applyDisclaimer(t){const i=this.config.disclaimerText||this.config.disclaimer_text;i&&""!==i.trim()&&(t.disclaimer={text:i,highContrast:e(this.config.disclaimerHighContrast||this.config.disclaimer_high_contrast)})}applyTypography(e){const t=this.config.customFont||{fontFamily:this.config.font_family,baseSize:this.config.font_size};t&&t.fontFamily&&""!==t.fontFamily.trim()&&(e.theme.typography={fontFamily:t.fontFamily,baseSize:parseInt(t.baseSize||16,10)})}buildHeaderConfig(){if(!e(this.config.showHeader))return{enabled:!1};const t={enabled:!0},i=this.config.headerTitleText||this.config.header_title_text;return i&&""!==i.trim()&&(t.title={enabled:!0,text:i}),[{icon:this.config.headerLeftIcon||this.config.header_left_icon,url:this.config.headerLeftUrl||this.config.header_left_url,target:"leftAction"},{icon:this.config.headerRightIcon||this.config.header_right_icon,url:this.config.headerRightUrl||this.config.header_right_url,target:"rightAction"}].forEach(({icon:e,url:i,target:n})=>{if(e&&i&&""!==i.trim())try{new URL(i),t[n]={icon:e,onClick:()=>{window.location.href=i}}}catch(e){console.warn("⚠️ Invalid header button URL, skipping",i)}}),t}applyHeader(e){e.header=this.buildHeaderConfig()}applyHistory(t){t.history={enabled:e(this.config.showHistory||this.config.show_history)}}applyLocale(e){const t=this.config.locale;t&&""!==t.trim()&&(e.locale=t)}apply(e){if(!this.enhancementsEnabled())return e.header={enabled:!1},void(e.history={enabled:!0});this.applyAttachments(e),this.applyInitialThread(e),this.applyDisclaimer(e),this.applyTypography(e),this.applyHeader(e),this.applyHistory(e),this.applyLocale(e)}}(r,l),d=(e=>async()=>{const t=e.i18n||{};try{if(!e.restUrl)throw new Error("Missing configuration");const t={"Content-Type":"application/json"},i=new AbortController,n=setTimeout(()=>i.abort(),1e4),a=await fetch(e.restUrl,{method:"POST",headers:t,signal:i.signal,credentials:"same-origin"});if(clearTimeout(n),!a.ok){const e=await a.json().catch(()=>({}));throw console.error("ChatKit Session Error:",{status:a.status,statusText:a.statusText,error:e}),new Error(e.message||`HTTP ${a.status}`)}const s=await a.json();if(!s.client_secret)throw new Error("Invalid response: missing client_secret");return s.client_secret}catch(e){console.error("Fetch Session Error:",e);const i=t.unableToStart||"⚠️ Unable to start chat. Please try again later.",n=document.getElementById("myChatkit");if(n&&n.parentNode){const e=document.createElement("div");e.style.cssText="padding: 20px; text-align: center; color: #721c24; background: #f8d7da; border-radius: 8px; margin: 20px;",e.setAttribute("role","alert"),e.innerHTML=`<p style="margin: 0; font-size: 14px;">${i}</p>`,n.parentNode.insertBefore(e,n)}return"undefined"!=typeof gtag&&gtag("event","exception",{description:`ChatKit session error: ${e.message}`,fatal:!1}),null}})(r),m=async()=>{if(!r.restUrl){console.error("ChatKit configuration missing: restUrl not defined");const e=r.i18n?.configError||"⚠️ Chat configuration error. Please contact support.";return void i(e)}t(r);try{await((e={})=>customElements.get("openai-chatkit")?Promise.resolve():new Promise((t,i)=>{const n=document.createElement("script");n.src=e.loaderUrl||"https://cdn.platform.openai.com/deployments/chatkit/chatkit.js",n.defer=!0,n.onload=t,n.onerror=()=>i(new Error("Failed to load ChatKit loader")),document.head.appendChild(n)}))(r)}catch(e){return console.error("Failed to load ChatKit loader",e),void i(r.i18n?.loadFailed||"⚠️ Chat widget failed to load. Please refresh the page.")}customElements.get("openai-chatkit")||await customElements.whenDefined("openai-chatkit");const e=document.getElementById("myChatkit");if(!e)return console.error("Element #myChatkit not found in DOM"),void i("⚠️ Chat widget failed to load. Please refresh the page.");(()=>{const e=document.getElementById("chatToggleBtn"),t=document.getElementById("myChatkit");if(!e||!t)return console.warn("ChatKit toggle elements not found"),null;const n=new s(r,{showError:i,flags:l}),a=new o({button:e,chatkitElement:t,channelPicker:n,accentColor:r.accentColor||"#FF4500",originalLabel:e.getAttribute("aria-label"),closeLabel:r.closeText||e.getAttribute("aria-label"),flags:l});if(!a.init())return null;const c=((e={},t,i)=>{const n=document.getElementById("chatkitNudge"),a=n?n.querySelector(".chatkit-nudge__dismiss"):null,s=Boolean(e.enabled&&n),o=1e3*Math.max(3,parseInt(e.initialDelay||12,10)),r=1e3*Math.max(10,parseInt(e.repeatDelay||36,10));let l=null,c=!1;const h=()=>{n&&(n.hidden=!0)},d=()=>{l&&(clearTimeout(l),l=null)},m=e=>{s&&!c&&(d(),l=setTimeout(()=>{s&&!c&&n&&(n.hidden=!1),m(r)},e))};return s&&t&&t.addEventListener("mouseenter",h),s&&n&&n.addEventListener("click",e=>{e.target!==a&&"function"==typeof i&&i()}),s&&a&&a.addEventListener("click",e=>{e.stopPropagation(),c=!0,h(),d()}),{enabled:s,scheduleInitial:()=>m(o),scheduleRepeat:()=>m(r),hide:h,cancel:d,markDismissed:()=>{c=!0,h(),d()}}})(r.nudge,e,()=>a.open());a.setNudgeManager(c),a.scheduleInitialNudge()})(),await(async e=>{const t={api:{getClientSecret:d},theme:{colorScheme:r.themeMode||"dark",radius:"round",density:"normal",color:{accent:{primary:r.accentColor||"#FF4500",level:parseInt(r.accentLevel||2,10)}},typography:{baseSize:16,fontFamily:'"OpenAI Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'}},composer:{attachments:{},placeholder:r.placeholderText||"Send a message..."},startScreen:{greeting:r.greetingText||"How can I help you today?",prompts:c.getPrompts()}};h.apply(t),t.history||(t.history={enabled:!0}),r.locale&&""!==r.locale.trim()&&!t.locale&&(t.locale=r.locale),console.log("🚀 Initializing ChatKit with final config:",t),e.style.display="block",e.setOptions(t),"undefined"!=typeof gtag&&gtag("event","chatkit_initialized",{event_category:"engagement",event_label:"ChatKit Ready"})})(e)};document.addEventListener("DOMContentLoaded",()=>{m().catch(e=>{console.error("❌ ChatKit Initialization Error:",e),i(r.i18n?.loadFailed||"⚠️ Chat initialization failed. Please refresh the page.")})}),document.addEventListener("visibilitychange",()=>{document.hidden||t(r)}),window.addEventListener("beforeunload",()=>{document.body.style.overflow=""})})();